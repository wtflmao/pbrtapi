<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>æ¨¡å‹ç®¡ç†è°ƒè¯•é¡µé¢</title>
    <link rel="stylesheet" href="/css/debug-models.css">
</head>
<body>
    <div class="container">
        <div class="models-list">
            <h2>
                æ¨¡å‹åˆ—è¡¨ 
                <button id="refreshModelsBtn" style="margin-left: 10px;">ğŸ”„ åˆ·æ–°</button>
            </h2>
            <div id="modelsList"></div>
        </div>
        
        <div class="right-section">
            <div class="log-section">
                <h2>æ—¥å¿—å°</h2>
                <div id="logContainer"></div>
            </div>

            <div class="upload-section">
                <h2>ä¸Šä¼ æ¨¡å‹</h2>
                <form id="uploadForm" enctype="multipart/form-data">
                    <input type="file" id="modelFile" name="model" accept=".zip,.obj,.glb,.gltf,.fbx,.3ds,.max,.ply,.pbrt">
                    <div id="infoJsonEditor" style="display: none;">
                        <h3>ç¼–è¾‘ info.json</h3>
                        <textarea id="infoJsonContent"></textarea>
                    </div>
                    <button type="submit">ä¸Šä¼ æ¨¡å‹</button>
                </form>
            </div>
        </div>
    </div>

    <div class="delete-section">
        <h2>åˆ é™¤æ¨¡å‹</h2>
        <form id="deleteModelForm">
            <input type="text" id="deleteModelUuid" placeholder="è¾“å…¥æ¨¡å‹UUID" required>
            <button type="submit">åˆ é™¤æ¨¡å‹</button>
        </form>
    </div>

    <!-- æ·»åŠ ä¸Šä¼ è¿›åº¦å¼¹æ¡† -->
    <div id="uploadProgress" class="upload-progress">
        <div class="upload-progress-content">
            <h3>æ–‡ä»¶ä¸Šä¼ ä¸­</h3>
            <div class="progress-bar-container">
                <div id="progressBar" class="progress-bar"></div>
            </div>
            <div id="progressText">0%</div>
            <div id="uploadSpeed">0 MB/s</div>
        </div>
    </div>

    <script>
        const modelFileInput = document.getElementById('modelFile');
        const uploadForm = document.getElementById('uploadForm');
        const deleteModelForm = document.getElementById('deleteModelForm');
        const deleteModelUuid = document.getElementById('deleteModelUuid');
        const modelsList = document.getElementById('modelsList');
        const infoJsonEditor = document.getElementById('infoJsonEditor');
        const infoJsonContent = document.getElementById('infoJsonContent');
        const logContainer = document.getElementById('logContainer');
        const refreshModelsBtn = document.getElementById('refreshModelsBtn');
        const uploadProgress = document.getElementById('uploadProgress');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const uploadSpeed = document.getElementById('uploadSpeed');

        function log(message, type = 'info') {
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${new Date().toLocaleString()}] ${message}`;
            logEntry.classList.add(type);
            logContainer.prepend(logEntry);
        }

        function formatSpeed(bytesPerSecond) {
            if (bytesPerSecond < 1024) {
                return `${bytesPerSecond.toFixed(1)} B/s`;
            } else if (bytesPerSecond < 1024 * 1024) {
                return `${(bytesPerSecond / 1024).toFixed(1)} KB/s`;
            } else {
                return `${(bytesPerSecond / (1024 * 1024)).toFixed(1)} MB/s`;
            }
        }

        function fetchModels() {
            fetch('/v1/model')
                .then(response => response.json())
                .then(models => {
                    modelsList.innerHTML = '';
                    models.forEach(model => {
                        const modelDiv = document.createElement('div');
                        modelDiv.innerHTML = `
                            <pre>${JSON.stringify(model, null, 2)}</pre>
                        `;
                        modelsList.appendChild(modelDiv);
                    });
                    log(`è·å–æ¨¡å‹åˆ—è¡¨æˆåŠŸï¼Œå…± ${models.length} ä¸ªæ¨¡å‹`);
                })
                .catch(error => {
                    log(`è·å–æ¨¡å‹åˆ—è¡¨å¤±è´¥: ${error.message}`, 'error');
                });
        }

        function deleteModel(uuid) {
            fetch(`/v1/model/${uuid}`, { method: 'DELETE' })
                .then(response => {
                    if (!response.ok) throw new Error('åˆ é™¤å¤±è´¥');
                    log(`æ¨¡å‹ ${uuid} åˆ é™¤æˆåŠŸ`, 'success');
                    fetchModels();
                })
                .catch(error => {
                    log(`åˆ é™¤æ¨¡å‹å¤±è´¥: ${error.message}`, 'error');
                });
        }

        deleteModelForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const uuid = deleteModelUuid.value.trim();
            
            if (!uuid) {
                log('è¯·è¾“å…¥æ¨¡å‹UUID', 'error');
                return;
            }

            deleteModel(uuid);
            deleteModelUuid.value = ''; // æ¸…ç©ºè¾“å…¥æ¡†
        });

        modelFileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            const ext = file.name.split('.').pop().toLowerCase();
            
            if (['obj', 'glb', 'gltf', 'fbx', '3ds', 'max', 'ply', 'pbrt', 'zip'].includes(ext)) {
                // ç”Ÿæˆä¸€ä¸ªå…¨å±€çš„ UUIDï¼Œåœ¨æ•´ä¸ªä¸Šä¼ è¿‡ç¨‹ä¸­ä¿æŒä¸€è‡´
                const consistentUuid = crypto.randomUUID();
                const name = file.name.split('.')[0] === "" ? (file.name.split('.')[1] ? file.name.split('.')[1] : file.name) : file.name.split('.')[0];
                const defaultInfoJson = JSON.stringify({
                    name: name,
                    type: 'satellite',
                    en_US: {
                        name: name,
                        description: 'This is a satellite model',
                    },
                    zh_CN: {
                        name: name,
                        description: 'è¿™æ˜¯ä¸€ä¸ªå«æ˜Ÿæ¨¡å‹',
                    }
                }, null, 2);
                
                // å°† UUID å­˜å‚¨åœ¨ä¸€ä¸ªå…¨å±€å˜é‡ä¸­ï¼Œä»¥ä¾¿åœ¨æäº¤æ—¶ä½¿ç”¨
                window.generatedModelUuid = consistentUuid;
                infoJsonContent.value = defaultInfoJson;
                infoJsonEditor.style.display = 'block';
            } else {
                infoJsonEditor.style.display = 'none';
                window.generatedModelUuid = null;
            }
        });

        uploadForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData();
            const modelFile = modelFileInput.files[0];
            
            if (!modelFile) {
                log('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶', 'error');
                return;
            }

            formData.append('model', modelFile);
            
            if (infoJsonEditor.style.display !== 'none') {
                try {
                    const infoJson = JSON.parse(infoJsonContent.value);
                    
                    // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦ä¿®æ”¹äº† UUID
                    // å¦‚æœç”¨æˆ·è¾“å…¥çš„ UUID ä¸ç”Ÿæˆçš„ UUID ä¸åŒï¼Œåˆ™ä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„ UUID
                    if (window.generatedModelUuid && infoJson.uuid !== window.generatedModelUuid) {
                        // ç”¨æˆ·ä¿®æ”¹äº† UUIDï¼Œä½¿ç”¨ç”¨æˆ·è¾“å…¥çš„ UUID
                        log('ä½¿ç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„ UUID', 'info');
                    } else {
                        // ä½¿ç”¨ç”Ÿæˆçš„ UUID
                        infoJson.uuid = window.generatedModelUuid;
                    }
                    
                    // åªæœ‰ézipæ–‡ä»¶æ‰è®¾ç½®model_path
                    const ext = modelFile.name.split('.').pop().toLowerCase();
                    if (ext !== 'zip') {
                        infoJson.model_path = modelFile.name;
                    }
                    formData.append('info', JSON.stringify(infoJson));
                } catch (error) {
                    log(`info.json è§£æé”™è¯¯: ${error.message}`, 'error');
                    return;
                }
            }

            // æ˜¾ç¤ºè¿›åº¦æ¡
            uploadProgress.style.display = 'flex';
            progressBar.style.width = '0%';
            progressText.textContent = '0%';
            uploadSpeed.textContent = '0 MB/s';

            const xhr = new XMLHttpRequest();
            let startTime = Date.now();
            let lastLoaded = 0;

            xhr.upload.addEventListener('progress', function(e) {
                if (e.lengthComputable) {
                    const currentTime = Date.now();
                    const timeElapsed = (currentTime - startTime) / 1000; // è½¬æ¢ä¸ºç§’
                    const bytesPerSecond = (e.loaded - lastLoaded) / timeElapsed;
                    
                    const percent = (e.loaded / e.total * 100).toFixed(1);
                    progressBar.style.width = percent + '%';
                    progressText.textContent = percent + '%';
                    uploadSpeed.textContent = formatSpeed(bytesPerSecond);

                    // æ›´æ–°ä¸Šæ¬¡åŠ è½½çš„å­—èŠ‚æ•°å’Œå¼€å§‹æ—¶é—´
                    lastLoaded = e.loaded;
                    startTime = currentTime;
                }
            });

            xhr.addEventListener('load', function() {
                // è®°å½•ä¸Šä¼ å®Œæˆçš„æ—¶é—´
                const uploadCompleteTime = Date.now();

                // è®¡ç®—è·ç¦»ä¸Šä¼ å¼€å§‹çš„æ—¶é—´
                const hideProgressBar = () => {
                    uploadProgress.style.display = 'none';
                    if (xhr.status === 200) {
                        const result = JSON.parse(xhr.responseText);
                        const infoJsonObj = JSON.parse(infoJsonContent.value);
                        infoJsonObj.uuid = result.uuid;
                        infoJsonContent.value = JSON.stringify(infoJsonObj, null, 2);
                        
                        log(`æ¨¡å‹ä¸Šä¼ æˆåŠŸ: ${result.name} (${result.uuid})`, 'success');
                        fetchModels();
                        uploadForm.reset();
                        infoJsonEditor.style.display = 'none';
                        window.generatedModelUuid = null;
                    } else {
                        try {
                            const errorData = JSON.parse(xhr.responseText);
                            log(`ä¸Šä¼ æ¨¡å‹å¤±è´¥: ${errorData.error}`, 'error');
                        } catch (e) {
                            log(`ä¸Šä¼ æ¨¡å‹å¤±è´¥: ${xhr.statusText}`, 'error');
                        }
                    }
                };

                // ç¡®ä¿è¿›åº¦æ¡è‡³å°‘å±•ç¤º2ç§’
                const MIN_DISPLAY_TIME = 2000; // 2ç§’
                const timeElapsed = Date.now() - startTime;

                if (timeElapsed < MIN_DISPLAY_TIME) {
                    // å¦‚æœä¸Šä¼ æ—¶é—´å°äº2ç§’ï¼Œå»¶è¿Ÿéšè—è¿›åº¦æ¡
                    setTimeout(hideProgressBar, MIN_DISPLAY_TIME - timeElapsed);
                } else {
                    // å¦åˆ™ç«‹å³éšè—
                    hideProgressBar();
                }
            });

            xhr.addEventListener('error', function() {
                uploadProgress.style.display = 'none';
                log('ä¸Šä¼ å¤±è´¥ï¼šç½‘ç»œé”™è¯¯', 'error');
                window.generatedModelUuid = null;
            });

            xhr.addEventListener('abort', function() {
                uploadProgress.style.display = 'none';
                log('ä¸Šä¼ å·²å–æ¶ˆ', 'info');
                window.generatedModelUuid = null;
            });

            xhr.open('POST', '/v1/model', true);
            xhr.send(formData);
        });

        refreshModelsBtn.addEventListener('click', () => {
            log('æ‰‹åŠ¨åˆ·æ–°æ¨¡å‹åˆ—è¡¨', 'info');
            fetchModels();
        });

        // åˆå§‹åŠ è½½
        fetchModels();
    </script>
</body>
</html> 